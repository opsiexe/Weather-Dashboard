services:
  backend:
    build:
      context: ./backend
    container_name: weather-backend
    restart: always
    environment:
      - PORT=5000
      - NODE_ENV=${NODE_ENV:-development}
      - WEATHER_API_KEY=${WEATHER_API_KEY}
      - GEOCODING_API_KEY=${GEOCODING_API_KEY}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      - CACHE_TTL_CURRENT=${CACHE_TTL_CURRENT:-300}
      - CACHE_TTL_FORECAST=${CACHE_TTL_FORECAST:-3600}
    ports:
      - "8742:5000"
    networks:
      - weather-net
    depends_on:
      - redis

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-}
        - VITE_MAPBOX_ACCESS_TOKEN=${VITE_MAPBOX_ACCESS_TOKEN}
    container_name: weather-frontend
    environment:
      - VITE_API_URL=${VITE_API_URL:-}
      - VITE_MAPBOX_ACCESS_TOKEN=${VITE_MAPBOX_ACCESS_TOKEN}
    ports:
      - "4567:80"
    networks:
      - weather-net
    depends_on:
      - backend

  redis:
    image: redis:7-alpine
    container_name: weather-redis
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "6482:6379"
    networks:
      - weather-net

networks:
  weather-net:
    driver: bridge

volumes:
  redis-data:
    driver: local
